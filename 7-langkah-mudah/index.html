<!DOCTYPE html>
<html lang=\"ms\">
<head>
  <meta charset=\"utf-8\" />
  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />
  <title>Indeks Repo</title>
  <style>
    :root{--bg:#0b0f14;--card:#111824;--text:#e6edf3;--muted:#9fb0c2;--accent:#2f81f7;--border:#223047;--ok:#2ea043;--warn:#d29922;--err:#f85149}
    html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
    header h1{font-size:20px;margin:0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px}
    .toolbar{display:flex;gap:8px;align-items:center;padding:12px;border-bottom:1px solid var(--border);flex-wrap:wrap}
    .toolbar input,.toolbar select,.toolbar button{background:#0d1320;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px}
    .toolbar input[type=\"search\"]{flex:1}
    .crumbs{padding:12px 16px;border-bottom:1px solid var(--border);font-size:14px}
    .crumbs a{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:14px}
    th{color:var(--muted);font-weight:600;text-align:left}
    tr:hover{background:#0f1524}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,Monaco,monospace}
    .tag{font-size:12px;border:1px solid var(--border);padding:2px 6px;border-radius:999px;color:var(--muted)}
    .footer{margin:18px 0;color:var(--muted);font-size:12px}
    .status{font-size:12px}
    .folder{color:#ffb86c}
    .file{color:#8be9fd}
    .danger{border-color:var(--err);color:var(--err)}
    .hidden{display:none}
    progress{accent-color:var(--accent)}
  </style>
  <!-- JSZip untuk zip folder subdirektori -->
  <script src=\"https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js\"></script>
</head>
<body>
  <div class=\"wrap\">
    <header>
      <h1>Indeks Kandungan Repo</h1>
      <span class=\"tag\" id=\"repoTag\">memuat…</span>
      <span class=\"status\" id=\"status\"></span>
    </header>

    <div class=\"card\">
      <div class=\"toolbar\">
        <input id=\"owner\" placeholder=\"owner (cth: username-org)\" />
        <input id=\"repo\" placeholder=\"repo (cth: nama-repo)\" />
        <input id=\"branch\" placeholder=\"cawangan (cth: main)\" />
        <button id=\"applyBtn\">Guna</button>
        <input type=\"search\" id=\"q\" placeholder=\"Tapis nama fail/folder…\" />
        <select id=\"sort\">
          <option value=\"name\">Nama</option>
          <option value=\"type\">Jenis</option>
          <option value=\"size\">Saiz</option>
        </select>
        <select id=\"order\">
          <option value=\"asc\">Menaik</option>
          <option value=\"desc\">Menurun</option>
        </select>
        <button id=\"downloadBtn\">Muat turun (folder ini)</button>
        <button id=\"cancelBtn\" class=\"danger hidden\">Batal</button>
        <span id=\"dlInfo\" class=\"status\"></span>
      </div>
      <div class=\"crumbs\" id=\"crumbs\"></div>
      <div style=\"overflow:auto\">
        <table id=\"list\">
          <thead>
            <tr>
              <th>Nama</th>
              <th>Jenis</th>
              <th class=\"mono\">Saiz</th>
              <th class=\"mono\">Terakhir Dikemaskini</th>
            </tr>
          </thead>
          <tbody id=\"rows\"></tbody>
        </table>
      </div>
    </div>

    <p class=\"footer\">Dikuasakan oleh GitHub REST API. Jika had kadar (rate limit) tercapai, cuba semula selepas beberapa minit atau tambah token peribadi baca-sahaja.</p>
  </div>

  <script>
    // ====== Konfigurasi lalai – cuba auto-kesan dari GitHub Pages ======
    const defaults = (() => {
      const url = new URL(window.location.href);
      const host = url.host.toLowerCase();
      const path = url.pathname.replace(/\/+$/, \"\");
      let owner = localStorage.getItem('gh_owner') || '';
      let repo  = localStorage.getItem('gh_repo')  || '';
      let branch= localStorage.getItem('gh_branch')|| 'main';
      let basePath = '';
      if (host.endsWith('.github.io')) {
        const segments = path.split('/').filter(Boolean);
        const sub = host.split('.')[0];
        owner = owner || sub;
        if (segments.length > 0) {
          repo = repo || segments[0];
          basePath = segments.slice(1).join('/');
        } else {
          repo = repo || `${sub}.github.io`;
        }
      }
      return {owner, repo, branch, basePath};
    })();

    const els = {
      owner: document.getElementById('owner'),
      repo: document.getElementById('repo'),
      branch: document.getElementById('branch'),
      apply: document.getElementById('applyBtn'),
      q: document.getElementById('q'),
      sort: document.getElementById('sort'),
      order: document.getElementById('order'),
      rows: document.getElementById('rows'),
      crumbs: document.getElementById('crumbs'),
      status: document.getElementById('status'),
      repoTag: document.getElementById('repoTag'),
      downloadBtn: document.getElementById('downloadBtn'),
      cancelBtn: document.getElementById('cancelBtn'),
      dlInfo: document.getElementById('dlInfo'),
    };

    els.owner.value = defaults.owner;
    els.repo.value = defaults.repo;
    els.branch.value = defaults.branch;

    let state = { owner: defaults.owner, repo: defaults.repo, branch: defaults.branch, path: defaults.basePath || '' };

    function setStatus(msg, type=''){
      els.status.textContent = msg || '';
      els.status.style.color = type==='err' ? 'var(--err)' : type==='warn' ? 'var(--warn)' : 'var(--muted)';
    }
    function setDlInfo(msg){ els.dlInfo.textContent = msg || ''; }

    function fmtBytes(n){
      if (n == null || isNaN(n)) return '-';
      const u=['B','KB','MB','GB','TB'];
      let i=0; let x=Number(n);
      while(x>=1024 && i<u.length-1){x/=1024;i++}
      return `${x.toFixed(x<10&&i>0?1:0)} ${u[i]}`;
    }
    function fmtDate(iso){
      if(!iso) return '-';
      const d = new Date(iso);
      if (isNaN(d.getTime())) return '-';
      return d.toLocaleString();
    }
    function savePrefs(){
      localStorage.setItem('gh_owner', state.owner);
      localStorage.setItem('gh_repo', state.repo);
      localStorage.setItem('gh_branch', state.branch);
    }
    function updateRepoTag(){
      const label = state.owner && state.repo ? `${state.owner}/${state.repo}@${state.branch}` : 'set repo';
      els.repoTag.textContent = label;
      els.downloadBtn.textContent = state.path ? 'Muat turun (folder ini)' : 'Muat turun repo (ZIP)';
    }
    function renderCrumbs(){
      const segs = state.path.split('/').filter(Boolean);
      const parts = ['<a href=\"#\" data-path=\"\">/</a>'];
      let acc = '';
      for (let i=0;i<segs.length;i++){
        acc += (i?'/':'') + segs[i];
        parts.push(`<a href=\"#\" data-path=\"${acc}\">${segs[i]}</a>`);
      }
      els.crumbs.innerHTML = parts.join(' / ');
      els.crumbs.querySelectorAll('a').forEach(a=>{
        a.addEventListener('click',e=>{e.preventDefault(); state.path=a.getAttribute('data-path'); load();});
      });
    }

    async function getCommitTimes(owner, repo, branch, path, names){
      const map = {};
      const limiter = 5; let idx = 0; let active = 0;
      return new Promise(resolve=>{
        function next(){
          if (idx>=names.length && active===0) return resolve(map);
          while(active<limiter && idx<names.length){
            const file = names[idx++]; active++;
            fetch(`https://api.github.com/repos/${owner}/${repo}/commits?sha=${encodeURIComponent(branch)}&path=${encodeURIComponent((path?path+'/':'')+file)}&per_page=1`)
              .then(r=>r.ok?r.json():[])
              .then(js=>{ map[file] = (Array.isArray(js)&&js[0]&&js[0].commit&&js[0].commit.committer)? js[0].commit.committer.date : null; })
              .catch(()=>{ map[file]=null; })
              .finally(()=>{ active--; next(); });
          }
        }
        next();
      });
    }

    async function load(){
      updateRepoTag();
      renderCrumbs();
      setStatus('Memuat…');
      els.rows.innerHTML = '';
      const api = `https://api.github.com/repos/${state.owner}/${state.repo}/contents/${state.path?encodeURIComponent(state.path):''}`;
      try{
        const res = await fetch(api);
        if(!res.ok){
          const t = await res.text();
          throw new Error(`${res.status} ${res.statusText}: ${t}`);
        }
        let data = await res.json();
        if(!Array.isArray(data)) data = [];
        if (state.path){ data.unshift({name:'..', type:'dir', _up:true}); }
        const names = data.filter(x=>!x._up).map(x=>x.name);
        const times = await getCommitTimes(state.owner, state.repo, state.branch, state.path, names);
        const q = els.q.value.trim().toLowerCase();
        if(q){ data = data.filter(x => x._up || x.name.toLowerCase().includes(q)); }
        const key = els.sort.value; const asc = els.order.value==='asc' ? 1 : -1;
        data.sort((a,b)=>{
          if (a._up) return -1; if (b._up) return 1;
          if (key==='type'){ const ta = a.type==='dir'?0:1; const tb = b.type==='dir'?0:1; if (ta!==tb) return (ta-tb)*asc; return a.name.localeCompare(b.name)*asc; }
          else if (key==='size'){ return ((a.size||0) - (b.size||0)) * asc; }
          else { return a.name.localeCompare(b.name)*asc; }
        });
        const frag = document.createDocumentFragment();
        for (const item of data){
          const tr = document.createElement('tr');
          const tdName = document.createElement('td');
          const tdType = document.createElement('td');
          const tdSize = document.createElement('td');
          const tdMod  = document.createElement('td');
          if (item._up){
            const a = document.createElement('a'); a.href = '#'; a.textContent = '.. (naik)'; a.className='folder';
            a.addEventListener('click', e=>{e.preventDefault(); const segs=state.path.split('/').filter(Boolean); segs.pop(); state.path=segs.join('/'); load();});
            tdName.appendChild(a); tdType.textContent = 'dir'; tdSize.textContent = '-'; tdMod.textContent = '-';
          } else if (item.type === 'dir'){
            const a = document.createElement('a'); a.href = '#'; a.textContent = item.name; a.className='folder';
            a.addEventListener('click', e=>{e.preventDefault(); state.path = (state.path?state.path+'/':'')+item.name; load();});
            tdName.appendChild(a); tdType.textContent = 'dir'; tdSize.textContent = '-'; tdMod.textContent = times[item.name]?fmtDate(times[item.name]):'-';
          } else if (item.type === 'file'){
            const raw = `https://raw.githubusercontent.com/${state.owner}/${state.repo}/${state.branch}/${state.path?state.path+'/':''}${encodeURIComponent(item.name)}`;
            const a = document.createElement('a'); a.href = raw; a.textContent = item.name; a.target = '_blank'; a.rel='noopener'; a.className='file';
            tdName.appendChild(a); tdType.textContent = item.type; tdSize.textContent = fmtBytes(item.size); tdMod.textContent = times[item.name]?fmtDate(times[item.name]):'-';
          } else {
            const a = document.createElement('a'); a.href = item.html_url || '#'; a.textContent = item.name; a.target='_blank';
            tdName.appendChild(a); tdType.textContent = item.type || '-'; tdSize.textContent = item.size?fmtBytes(item.size):'-'; tdMod.textContent = times[item.name]?fmtDate(times[item.name]):'-';
          }
          tr.appendChild(tdName); tr.appendChild(tdType); tr.appendChild(tdSize); tr.appendChild(tdMod); frag.appendChild(tr);
        }
        els.rows.appendChild(frag);
        setStatus(`${data.length} item dipaparkan`);
      } catch(err){ console.error(err); setStatus(`Ralat: ${err.message}`, 'err'); }
    }

    // ====== Muat Turun (ZIP) ======
    let cancelDownload = false;

    async function listRecursive(path){
      const api = `https://api.github.com/repos/${state.owner}/${state.repo}/contents/${path?encodeURIComponent(path):''}?ref=${encodeURIComponent(state.branch)}`;
      const res = await fetch(api);
      if(!res.ok){ const t = await res.text(); throw new Error(`Gagal senarai ${path||'/'}: ${res.status} ${res.statusText}`); }
      const data = await res.json();
      let files = [];
      for (const item of data){
        if (cancelDownload) throw new Error('Dibatalkan pengguna');
        if (item.type === 'file'){
          files.push({ path: item.path, size: item.size||0 });
        } else if (item.type === 'dir'){
          const sub = await listRecursive(item.path);
          files = files.concat(sub);
        }
        // Abaikan symlink/submodule untuk ringkas
      }
      return files;
    }

    async function downloadFolder(){
      if(!state.owner || !state.repo){ return alert('Sila isi owner & repo, kemudian tekan Guna.'); }
      if(!state.path){
        // Muat turun keseluruhan repo sebagai zip menggunakan codeload (lebih stabil untuk muat turun)
        const url = `https://codeload.github.com/${state.owner}/${state.repo}/zip/refs/heads/${state.branch}`;
        window.location.href = url; return;
      }
      cancelDownload = false; els.cancelBtn.classList.remove('hidden');
      setDlInfo('Mengumpul senarai fail…');
      try{
        const files = await listRecursive(state.path);
        if (files.length === 0){ setDlInfo('Tiada fail untuk dimuat turun.'); els.cancelBtn.classList.add('hidden'); return; }
        const totalSize = files.reduce((a,b)=>a+(b.size||0),0);
        if (totalSize > 150*1024*1024){ // 150MB amaran
          const ok = confirm(`Amaran: jumlah anggaran ${fmtBytes(totalSize)} untuk folder ini. Teruskan?`);
          if (!ok){ els.cancelBtn.classList.add('hidden'); setDlInfo('Dibatalkan.'); return; }
        }
        const zip = new JSZip();
        let done = 0; const maxParallel = 6; let idx=0; let active=0;
        setDlInfo(`0/${files.length} fail (0%)`);
        await new Promise((resolve, reject)=>{
          function next(){
            if (cancelDownload){ return reject(new Error('Dibatalkan pengguna')); }
            if (idx>=files.length && active===0) return resolve();
            while(active<maxParallel && idx<files.length){
              const f = files[idx++]; active++;
              const rawUrl = `https://raw.githubusercontent.com/${state.owner}/${state.repo}/${state.branch}/${encodeURIComponent(f.path)}`;
              fetch(rawUrl)
                .then(r=>{ if(!r.ok) throw new Error(`Gagal muat: ${f.path} (${r.status})`); return r.blob(); })
                .then(blob=> zip.file(f.path.replace(new RegExp('^'+state.path.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')+'/'), ''), blob))
                .then(()=>{ done++; const pct = Math.floor((done/files.length)*100); setDlInfo(`${done}/${files.length} fail (${pct}%)`); })
                .catch(err=>{ console.error(err); /* teruskan walaupun gagal satu fail */ })
                .finally(()=>{ active--; next(); });
            }
          }
          next();
        });
        setDlInfo('Menjana ZIP…');
        const zipBlob = await zip.generateAsync({type:'blob', compression:'DEFLATE', compressionOptions:{level:6}});
        const fnSafe = (state.repo + '-' + state.path.replace(/\/+$/,'').replace(/\//g,'_')).toLowerCase();
        const a = document.createElement('a'); a.href = URL.createObjectURL(zipBlob); a.download = `${fnSafe}.zip`;
        document.body.appendChild(a); a.click(); a.remove();
        setDlInfo(`Selesai: ${files.length} fail, ~${fmtBytes(totalSize)}`);
      } catch(err){ console.error(err); setDlInfo(`Ralat: ${err.message}`); }
      finally { els.cancelBtn.classList.add('hidden'); }
    }

    // Event listeners
    els.apply.addEventListener('click', ()=>{ state.owner = els.owner.value.trim(); state.repo = els.repo.value.trim(); state.branch = els.branch.value.trim()||'main'; state.path=''; savePrefs(); load(); });
    els.q.addEventListener('input', ()=> load());
    els.sort.addEventListener('change', ()=> load());
    els.order.addEventListener('change', ()=> load());
    els.downloadBtn.addEventListener('click', ()=> downloadFolder());
    els.cancelBtn.addEventListener('click', ()=>{ cancelDownload = true; els.cancelBtn.classList.add('hidden'); setDlInfo('Membatalkan…'); });

    // Mulakan
    updateRepoTag(); renderCrumbs(); if (state.owner && state.repo){ load(); } else { setStatus('Sila masukkan owner dan repo, kemudian tekan Guna.'); }
  </script>
</body>
</html>
